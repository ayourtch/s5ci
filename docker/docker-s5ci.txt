# Download base ubuntu image
FROM ubuntu:18.04

RUN echo force-update-25-jun-2019

RUN apt-get update
RUN apt-get upgrade -y && true

# VPP prerequisites
RUN apt-get install -y curl build-essential autoconf automake ccache debhelper dkms git libtool libapr1-dev dh-systemd
RUN apt-get install -y libconfuse-dev git-review exuberant-ctags cscope pkg-config
RUN apt-get install -y lcov chrpath autoconf indent clang-format libnuma-dev
RUN apt-get install -y python-all python-dev python-virtualenv python-pip libffi6 check
RUN apt-get install -y libboost-all-dev libffi-dev python-ply libmbedtls-dev
RUN apt-get install -y cmake ninja-build uuid-dev libssl-dev

# s5ci prereq
RUN apt-get install -y libpq5
# browse the results
RUN apt-get install -y nginx
# make the jobs dir
RUN mkdir /var/www/html/jobs

RUN apt-get install -y build-essential git sudo gdb
RUN apt-get install -y iperf3 && true
RUN mkdir /CCACHE

RUN mkdir /s5ci
RUN mkdir /s5ci/db
RUN mkdir /s5ci/scripts
RUN mkdir /s5ci/templates
COPY tmp/templates /s5ci/templates
COPY tmp/config.yaml /s5ci
COPY tmp/scripts /s5ci/scripts
COPY tmp/s5ci.sqlite3 /s5ci/db
COPY tmp/s5ci /usr/local/bin/s5ci

CMD ["/bin/bash", "-c", "service nginx start && RUST_LOG=debug RUST_BACKTRACE=1 /usr/local/bin/s5ci -c /s5ci/config.yaml"]

